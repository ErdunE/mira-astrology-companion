name: Project CI

on:
  pull_request:
    branches: [ "main", "dev" ]
  # push:
  #   branches: [ "dev" ]

jobs:
  # 1. Validate PR Template Compliance
  pr-template-check:
    name: PR Template Compliance
    runs-on: ubuntu-latest
    env:
      PR_BODY: ${{ github.event.pull_request.body }}
    steps:
      - uses: actions/checkout@v3

      - name: Validate PR Body Formatting
        run: |
          echo "Checking PR template compliance..."
          echo "----- PR body (first 200 chars) -----"
          echo "${PR_BODY:0:200}"
          echo "-------------------------------------"

          if [ -z "$PR_BODY" ]; then
            echo "ERROR: PR body is empty"
            echo ""
            echo "Fix: Fill out the PR template with required sections"
            echo "Template location: .github/pull_request_template.md"
            exit 1
          fi

          REQUIRED_FIELDS=("## Summary" "## Linked Ticket" "## Changes" "## Testing")
          MISSING=false

          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! grep -q "$field" <<< "$PR_BODY"; then
              echo "Missing required section: $field"
              MISSING=true
            fi
          done

          if [ "$MISSING" = true ]; then
            echo ""
            echo "Fix: Add all required sections to your PR description:"
            echo "  - ## Summary"
            echo "  - ## Linked Ticket"
            echo "  - ## Changes"
            echo "  - ## Testing"
            echo ""
            echo "See .github/pull_request_template.md for the complete template"
            exit 1
          else
            echo "PR template looks good"
          fi

  # 2. Backend Python Checks
  python-backend:
    name: Backend Python CI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - id: check_backend
        name: Check if backend exists
        run: |
          if [ -d "app/backend" ] && [ "$(ls -A app/backend)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          if [ -f "app/backend/requirements.txt" ]; then
            pip install -r app/backend/requirements.txt
            pip install flake8 black pytest
          else
            echo "No backend requirements found. Skipping."
          fi

      - name: Python Syntax Check
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          echo "Checking Python syntax..."
          FILES="$(git ls-files '*.py')"
          if [ -z "$FILES" ]; then
            echo "No Python files found. Skipping syntax check."
            exit 0
          fi
          
          if ! python -m py_compile $FILES; then
            echo ""
            echo "ERROR: Python syntax errors found"
            echo ""
            echo "Fix: Check the error messages above for specific syntax issues"
            echo "Common issues:"
            echo "  - Missing colons (:)"
            echo "  - Incorrect indentation"
            echo "  - Unclosed parentheses/brackets"
            exit 1
          fi
          echo "Python syntax check passed"

      - name: Black Format Check
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          echo "Checking code formatting with black..."
          
          if ! black --check app/backend --exclude venv --line-length=120; then
            echo ""
            echo "ERROR: Code formatting issues found"
            echo ""
            echo "Fix: Run the following command to auto-format your code:"
            echo "  cd app/backend"
            echo "  black . --exclude venv --line-length=120"
            echo "  git add ."
            echo "  git commit --amend --no-edit"
            echo "  git push --force-with-lease"
            exit 1
          fi
          echo "Code formatting is correct"

      - name: Flake8 Lint
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          echo "Running flake8 linting..."
          
          if ! flake8 app/backend --exclude=venv --max-line-length=120 --ignore=E203,W503; then
            echo ""
            echo "ERROR: Code style issues found"
            echo ""
            echo "Fix: Review the errors above and fix them manually, or:"
            echo "  - For unused imports: Remove them"
            echo "  - For unused variables: Remove or use them"
            echo "  - For line length: Break long lines"
            echo ""
            echo "To check locally:"
            echo "  cd app/backend"
            echo "  flake8 . --exclude=venv --max-line-length=120 --ignore=E203,W503"
            exit 1
          fi
          echo "Flake8 linting passed"

      - name: Run Backend Tests
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          echo "Running backend tests..."
          cd app/backend
          
          # Run api_wrapper tests
          if [ -f "common/api_wrapper.py" ]; then
            echo "Testing API wrapper..."
            if ! python common/api_wrapper.py; then
              echo ""
              echo "ERROR: API wrapper tests failed"
              echo ""
              echo "Fix: Check the error messages above"
              echo "Test locally: python app/backend/common/api_wrapper.py"
              exit 1
            fi
          fi
          
          # Run pytest if test files exist
          if find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
            echo "Running pytest..."
            if ! pytest; then
              echo ""
              echo "ERROR: Unit tests failed"
              echo ""
              echo "Fix: Check the error messages above"
              echo "Test locally: cd app/backend && pytest"
              exit 1
            fi
          else
            echo "No pytest tests found. Skipping."
          fi
          
          echo "All backend tests passed"

  # 3. Frontend Checks
  frontend-build:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - id: check_frontend
        name: Check if frontend exists
        run: |
          if [ -d "app/frontend" ] && [ "$(ls -A app/frontend)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect package.json
        if: steps.check_frontend.outputs.exists == 'true'
        id: detect_pkg
        run: |
          if [ -f "app/frontend/package.json" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        if: steps.detect_pkg.outputs.found == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Dependencies
        if: steps.detect_pkg.outputs.found == 'true'
        run: |
          cd app/frontend
          npm install

      - name: ESLint Check
        if: steps.detect_pkg.outputs.found == 'true'
        continue-on-error: true
        run: |
          cd app/frontend
          echo "Running ESLint..."
          
          if ! npm run lint; then
            echo ""
            echo "WARNING: ESLint issues found (non-blocking)"
            echo ""
            echo "Fix: Review the linting errors above"
            echo "Common fixes:"
            echo "  - Remove unused imports/variables"
            echo "  - Fix React Hook dependencies"
            echo "  - Update eslint.config.js to adjust rules"
            echo ""
            echo "This check is non-blocking but should be addressed"
          else
            echo "ESLint check passed"
          fi

      - name: Build Frontend
        if: steps.detect_pkg.outputs.found == 'true'
        run: |
          cd app/frontend
          echo "Building frontend..."
          
          if ! npm run build; then
            echo ""
            echo "ERROR: Frontend build failed"
            echo ""
            echo "Fix: Check the error messages above"
            echo "Common issues:"
            echo "  - TypeScript type errors"
            echo "  - Missing dependencies"
            echo "  - Syntax errors in JSX/TSX files"
            echo ""
            echo "Test locally:"
            echo "  cd app/frontend"
            echo "  npm install"
            echo "  npm run build"
            exit 1
          fi
          echo "Frontend build successful"

  # 4. Terraform Validation
  terraform-validate:
    name: Terraform Validate & Format
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - id: check_tf
        name: Check for Terraform files
        run: |
          echo "Searching for .tf files in infra/..."
          if find infra -name "*.tf" -type f | grep -q .; then
            TF_COUNT=$(find infra -name "*.tf" -type f | wc -l)
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found $TF_COUNT Terraform files"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No Terraform files found"
          fi

      - name: Install Terraform
        if: steps.check_tf.outputs.exists == 'true'
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Format Check
        if: steps.check_tf.outputs.exists == 'true'
        run: |
          cd infra/terraform
          echo "Checking Terraform formatting..."
          
          if ! terraform fmt -check -recursive; then
            echo ""
            echo "ERROR: Terraform files need formatting"
            echo ""
            echo "Fix: Run the following commands to auto-format:"
            echo "  cd infra/terraform"
            echo "  terraform fmt -recursive"
            echo "  git add ."
            echo "  git commit --amend --no-edit"
            echo "  git push --force-with-lease"
            echo ""
            echo "Files needing formatting are listed above"
            exit 1
          fi
          echo "âœ… All Terraform files properly formatted"

      - name: Terraform Init
        if: steps.check_tf.outputs.exists == 'true'
        run: |
          cd infra/terraform
          echo "Initializing Terraform..."
          
          if ! terraform init -backend=false; then
            echo ""
            echo "ERROR: Terraform initialization failed"
            echo ""
            echo "Common issues:"
            echo "  - Invalid provider configuration"
            echo "  - Missing required providers"
            echo "  - Syntax errors in .tf files"
            echo ""
            echo "Test locally:"
            echo "  cd infra/terraform"
            echo "  terraform init -backend=false"
            exit 1
          fi
          echo "Terraform initialized successfully"

      - name: Terraform Validate
        if: steps.check_tf.outputs.exists == 'true'
        run: |
          cd infra/terraform
          echo "Validating Terraform configuration..."
          
          if ! terraform validate; then
            echo ""
            echo "ERROR: Terraform validation failed"
            echo ""
            echo "Common issues:"
            echo "  - Missing required variables"
            echo "  - Invalid resource references"
            echo "  - Type mismatches"
            echo "  - Circular dependencies"
            echo ""
            echo "Test locally:"
            echo "  cd infra/terraform"
            echo "  terraform init -backend=false"
            echo "  terraform validate"
            exit 1
          fi
          echo "Terraform configuration is valid"

  # 5. Security & Secrets Scan
  security-scan:
    name: Security & Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Scan for AWS Credentials
        run: |
          echo "Scanning for AWS credentials..."
          if grep -R "AKIA[0-9A-Z]\{16\}" -n . --exclude-dir=node_modules --exclude-dir=venv --exclude-dir=dist; then
            echo ""
            echo "ERROR: AWS Access Key detected in code!"
            echo ""
            echo "Fix: Remove the AWS credentials from your code"
            echo "  1. Find the file(s) listed above"
            echo "  2. Remove the AKIA... key"
            echo "  3. Use AWS Secrets Manager or environment variables instead"
            echo "  4. Commit the change"
            echo ""
            echo "SECURITY RISK: Never commit AWS credentials to Git!"
            exit 1
          fi
          echo "No AWS access keys found"

      - name: Scan for Secret Keys
        run: |
          echo "Scanning for private keys..."
          if grep -R "BEGIN.*PRIVATE KEY" -n . --exclude-dir=node_modules --exclude-dir=venv --exclude-dir=dist --exclude=ci.yml; then
            echo ""
            echo "ERROR: Private key detected in code!"
            echo ""
            echo "Fix: Remove the private key from your code"
            echo "  1. Find the file(s) listed above"
            echo "  2. Remove the private key"
            echo "  3. Store it securely in AWS Secrets Manager"
            echo "  4. Add the file to .gitignore if it's a key file"
            echo ""
            echo "SECURITY RISK: Never commit private keys to Git!"
            exit 1
          fi
          echo "No private keys found"

      - name: Check for Sensitive Files
        run: |
          echo "Checking for sensitive files..."
          SENSITIVE_PATTERNS=(".env" ".env.local" "*.pem" "*.key" "*.p12" "*.pfx")
          FOUND=false
          FOUND_FILES=""
          
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            FILES=$(find . -name "$pattern" -not -path "./node_modules/*" -not -path "./venv/*" -not -path "./dist/*")
            if [ -n "$FILES" ]; then
              echo "Found sensitive file pattern: $pattern"
              echo "$FILES"
              FOUND=true
              FOUND_FILES="$FOUND_FILES\n$FILES"
            fi
          done
          
          if [ "$FOUND" = true ]; then
            echo ""
            echo "ERROR: Sensitive files detected!"
            echo ""
            echo "Fix: Remove these files or add them to .gitignore"
            echo "  1. Delete the files listed above (or move them outside the repo)"
            echo "  2. Add patterns to .gitignore:"
            echo "     .env"
            echo "     .env.local"
            echo "     *.pem"
            echo "     *.key"
            echo "  3. Commit the changes"
            echo ""
            echo "SECURITY RISK: Don't commit sensitive files to Git!"
            exit 1
          fi
          echo "No sensitive files found"